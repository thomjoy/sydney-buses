<!DOCTYPE html>
<html>
<head>
  <title>Sydney Buses</title>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css' />
  <link rel="stylesheet" href="bower_components/nprogress/nprogress.css" />
  <link rel='stylesheet' href="style.css" />
  <script src='//cdn.leafletjs.com/leaflet-0.6.4/leaflet.js'></script>
  <script src='//code.jquery.com/jquery-2.0.3.min.js'></script>
  <script src='bower_components/underscore/underscore.js'></script>
  <script src="bower_components/nprogress/nprogress.js"></script>
</head>
<body>
  <div class="sidebar">
    <label>Route</label>
    <select id="route"></select>
    <label>Destination</label>
    <select id="trip"></select>
    <ul id="stop-times">
    </ul>
  </div>
  <div id='map'></div>
  <script>
    var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/22677/256/{z}/{x}/{y}.png'
        cloudmadeAttribution = 'Map data &copy; 2013 OpenStreetMap contributors, Imagery &copy; 2013 CloudMade',
        layerOptions = { maxZoom: 18, attribution: cloudmadeAttribution, styleId: 22677 },
        layer = L.tileLayer(cloudmadeUrl, layerOptions),
        map = L.map('map',{
          zoom: 10,
          layers: [layer]
        }),
        layerGroup = new L.LayerGroup(),
        layerCache = new LayerCache(),
        routes = $.ajax({ url: 'http://localhost:9000/route' });

    // Quick cache
    function LayerCache() {
      var layers = {};
      return {
        add: function(layer, key) {
          if( !layers[key] ) {
            layers[key] = layer;
          }
        },
        get: function(key) {
          return layers[key];
        }
      }
    }

    $( document ).ajaxStart(function() {
        NProgress.start();
    });
    $( document ).ajaxStop(function() {
        NProgress.done();
    });

    // --- Go --- //
    $.when( routes ).then(function(routeJson) {
      var $route = $('#route');
      var $trip = $('#trip');

      _.each(routeJson, function(r) {
        var shortName = r.route_short_name,
            routeId = r.route_id,
            option = '<option data-name="' + routeId + '">' + shortName + '</option>';

        $route.append(option);
      });

      $trip.on('change', function(evt) {
        var optionSelected = $("option:selected", this);
        var tripId = $(optionSelected).attr('data-name');

        var getStops = $.ajax({
          url: 'http://localhost:9000/stops/' + tripId
        });

        $.when( getStops ).then(function( stops ) {
          var $ul = $('#stop-times');
          var listItems = [];
        
          _.each(stops, function(stop) {
            var li = '<li id="' + stop.stop_id + '">';
                li += "<h4>" + stop.stop_name + "</h4>";
                li += "<div>Arrive: " + stop.arrival_time + "</div>";
                li += "<div>Depart: " + stop.departure_time + "</div>";
                li += '<div class="add-to-map" data-latlon="' + stop.stop_lat + ',' + stop.stop_lon + '">Show on Map</div>';
                li += "</li>";
            listItems.push(li);
          });

          $ul.empty().append(listItems);
  
          $('.add-to-map').on('click', function() {
            var coords = $(this).data('latlon').split(',');
            var latLng = new L.LatLng(coords[0], coords[1]);
            var m = new L.Marker(latLng).toGeoJSON();
            var markerLayer = L.geoJson(m, {
              onEachFeature: function(feature, layer) {
                layer.on({
                  click: function() { 
                   console.log(feature);
                  },
                  mouseover: function(evt) {
                  },
                  mouseout: function(evt) {
                  }
                });
              }
            }).addTo(map);

            //map.fitBounds(latLng);
            map.panTo(latLng);
            map.setZoom(16);
          });
        });
      });

      $route.on('change', function(evt) {
        var optionSelected = $("option:selected", this);
        var routeId = $(optionSelected).attr('data-name');
        var getShapes = $.ajax({
          url: 'http://localhost:9000/shape/' + routeId
        });
        var getTrips = $.ajax({
          url: 'http://localhost:9000/trip/' + routeId
        });

        $.when( getShapes, getTrips ).then(function(shapesJson, tripsJson) {
          var myStyle = {
            "color": "#29d",
            "weight": 1,
            "opacity": 1
          };
          var trips = [];
          
          _.each(tripsJson[0].trips, function(t) {
            var name = t.trip_headsign,
                tripId = t.trip_id;

            trips.push('<option data-name="' + tripId + '">' + name + '</option>');
          });

          $('#trip option').remove();
          $('#trip').append(trips);

          var shapeLayer,
              markerLayer,
              cacheKey = shapesJson[0].properties.shape_id,
              cachedLayer = layerCache.get(cacheKey);

          if( !cachedLayer ) {
            shapeLayer = L.geoJson(shapesJson[0], {
              onEachFeature: function(feature, layer) {
                layer.setStyle(myStyle);
                layer.on({
                  click: function() {
                    console.log(feature);
                  },
                  mouseover: function(evt) {
                  },
                  mouseout: function(evt) {
                  }
                });
              }
            });

            layerCache.add(cacheKey)
          }
          else {
            shapeLayer = cachedLayer;
          }

          layerGroup.addLayer(shapeLayer);
        });
      });
    });

    layerGroup.addTo(map);

    $('#map').css('height', function() { return document.body.clientHeight || '800px'; });
    map.setView([-33.8600, 151.2111], 10);
  </script>
</body>
</html>